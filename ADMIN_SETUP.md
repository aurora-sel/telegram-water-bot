# 管理员功能配置指南

## 📌 概述

v2.0 提供了**管理员系统**，允许指定的用户执行特殊的管理员命令：

- `/admin_stats` - 查看全局统计（用户数、活跃度）
- `/blacklist` - 拉黑用户（禁止使用机器人）
- `/unblacklist` - 解除用户拉黑
- `/user_info` - 查看用户详细信息和统计

---

## 🔧 如何设置管理员

### 第 1 步：获取你的 Telegram ID

1. **在 Telegram 中搜索** `@userinfobot`
2. **点击 Start**
3. **复制你的 ID 号**

例如：`123456789`

### 第 2 步：配置环境变量

#### 方式 A：本地部署（.env 文件）

创建或编辑 `.env` 文件：

```env
TELEGRAM_TOKEN=your_bot_token
DATABASE_URL=postgresql://...
ADMIN_IDS=123456789
```

**多个管理员（用逗号分隔，无空格）：**
```env
ADMIN_IDS=123456789,987654321,555666777
```

#### 方式 B：Koyeb 部署

1. **登录 Koyeb 仪表板**
2. **选择你的应用**
3. **点击 Settings → Environment variables**
4. **添加新变量：**
   - Name: `ADMIN_IDS`
   - Value: `123456789` （你的 Telegram ID）
   
   **多个管理员：** `123456789,987654321`

5. **点击 Save**
6. **点击 Redeploy** 应用重启以应用设置

---

## ✅ 验证管理员配置

### 方式 1：查看日志

部署后，查看 Koyeb 日志，应该看到（如果配置了管理员）：

```
ADMIN_IDS 配置成功: [123456789]
```

### 方式 2：在 Telegram 中测试

1. 用你的账号向 Bot 发送 `/admin_stats`
   - ✅ 如果显示统计，说明你已设置为管理员
   - ❌ 如果显示"无权限"，说明设置未生效

2. 试试其他管理员命令：
   ```
   /blacklist 999999999 spam   # 拉黑用户
   /user_info 123456789        # 查看用户信息
   ```

---

## 📋 管理员命令详解

### 1. `/admin_stats`
**功能：** 查看全局统计

**输出示例：**
```
👥 全局统计
总用户数: 5
活跃用户数: 3
黑名单用户数: 1
```

**权限：** 仅管理员

---

### 2. `/blacklist [用户ID] [原因]`
**功能：** 将用户加入黑名单（禁止使用所有功能）

**用法：**
```
/blacklist 987654321 spam
/blacklist 999999999 abuse
```

**效果：**
- 用户所有命令都会被拒绝
- 用户会收到"您已被禁用"消息

**权限：** 仅管理员

---

### 3. `/unblacklist [用户ID]`
**功能：** 将用户从黑名单移除

**用法：**
```
/unblacklist 987654321
```

**权限：** 仅管理员

---

### 4. `/user_info [用户ID]`
**功能：** 查看用户详细信息和统计

**用法：**
```
/user_info 987654321
```

**输出示例：**
```
👤 用户信息

用户 ID: 987654321
每日目标: 2500 ml
提醒间隔: 60 分钟
时区: UTC+8
活跃时段: 08:00 ~ 22:00
提醒状态: ✅ 启用
黑名单状态: ✅ 正常
今日饮水: 1200 ml
账户创建: 2026-02-01 10:30:45
```

**权限：** 仅管理员

---

## ⚠️ 常见问题

### Q1: 我设置了 ADMIN_IDS，但管理员命令仍然说无权限

**A:** 可能原因和解决方案：

1. **Koyeb 部署未完成**
   - 检查应用状态是否为 "Healthy"
   - 等待部署完成（2-3 分钟）

2. **环境变量未被保存**
   - 重新检查 Koyeb Settings 中的 ADMIN_IDS 值
   - 确保没有多余空格或错误

3. **ID 不匹配**
   - 确认使用的是你的正确 Telegram ID（不是用户名）
   - 用 @userinfobot 再次验证

4. **格式错误**
   - 多个管理员必须用逗号分隔，且**无空格**
   - ✅ 正确：`123456789,987654321`
   - ❌ 错误：`123456789, 987654321` （有空格）

**解决：**
```
1. 手动 SSH 到 Koyeb（或用本地部署）
2. 查看日志找到错误信息
3. 或临时在 .env 中写死 ADMIN_IDS 测试
```

### Q2: 我想让多个人成为管理员怎么办？

**A:** 多个 ID 用逗号分隔：

```env
ADMIN_IDS=123456789,987654321,555666777
```

### Q3: 我可以在不重启 Bot 的情况下添加管理员吗？

**A:** 不可以。需要修改环境变量后，在 Koyeb 中点击 Redeploy，或本地修改 .env 后重启应用。

### Q4: 如果我拉黑了错误的用户怎么办？

**A:** 用 `/unblacklist [ID]` 解除拉黑：

```
/unblacklist 987654321
```

### Q5: 管理员命令的日志在哪里？

**A:** 查看 Koyeb 日志中以 `[管理员]` 开头的行：

```
[管理员] 用户 123456789 拉黑了用户 987654321：spam
[管理员] 用户 123456789 查看了用户 555666777 的信息
```

---

## 🔐 安全提示

1. **不要分享你的 ADMIN_IDS**
   - 这样其他人就无法成为管理员

2. **定期审查黑名单**
   - 检查 `/admin_stats` 中的黑名单用户数
   - 必要时解除不需要的拉黑

3. **备份 ADMIN_IDS 配置**
   - 如果迁移到新服务器，记住你的管理员 ID

---

## 📝 配置检查清单

在使用管理员功能前，确认以下各项：

- [ ] 获取了自己的 Telegram ID
- [ ] 在 Koyeb 环境变量中设置了 ADMIN_IDS
- [ ] 点击了 Redeploy 重启应用
- [ ] 应用状态显示 Healthy
- [ ] 日志显示 ADMIN_IDS 配置成功
- [ ] 测试命令 `/admin_stats` 有响应
- [ ] 没有出现"无权限"错误

---

## 完整环境变量示例

```env
# 必需
TELEGRAM_TOKEN=1234567890:ABCDefGHIjklmnoPQRstUvwxyz_1234567890

DATABASE_URL=postgresql://user:password@host:5432/water_reminder

# 可选但推荐
ADMIN_IDS=123456789,987654321

PORT=8080

WEBHOOK_URL=https://your-domain.com/webhook

UPTIMEROBOT_URL=https://api.uptimerobot.com/v2/api.php
```

---

## 获取帮助

如果仍有问题：

1. 查看 [QUICK_START.md](QUICK_START.md) - 快速开始
2. 查看 [DEPLOYMENT_QUICK_FIX.md](DEPLOYMENT_QUICK_FIX.md) - 故障排查
3. 查看 Koyeb 日志找出错误信息
4. 在本地用 .env 文件测试管理员功能

---

**提示：** 管理员功能是可选的。如果不设置 ADMIN_IDS，机器人仍然可以正常工作，只是无法使用管理员命令。
