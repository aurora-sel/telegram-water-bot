# 🚀 机器人功能更新 - 管理员、用户管理、自动清理

**更新日期：** 2026-02-03  
**版本：** 2.0  
**状态：** ✅ 完成

---

## 📋 更新内容概览

### 1️⃣ 永不休眠功能（Render 环境变量配置）
### 2️⃣ 管理员系统（添加管理权限）
### 3️⃣ 用户数据管理（重置、禁用、删除）
### 4️⃣ 自动清理过期用户（7 天未交互）

---

## 🔧 环境变量配置

### 新增的环境变量

| 变量名 | 必需 | 说明 | 示例 |
|--------|------|------|------|
| `ADMIN_IDS` | ❌ | 管理员 Telegram ID（逗号分隔） | `123456789,987654321` |
| `UPTIMEROBOT_URL` | ❌ | UptimeRobot 监控 URL（可选） | `https://api.uptimerobot.com/...` |

### 已有的环境变量（必需）

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `TELEGRAM_TOKEN` | Bot Token | `1234567890:ABCD...` |
| `DATABASE_URL` | PostgreSQL URL | `postgresql://user:pass@host/db` |
| `PORT` | 监听端口 | `8080` |

---

## 👨‍💼 管理员功能

### 设置管理员

1. **获取你的 Telegram ID**
   - 给 @userinfobot 发送任意消息
   - 它会回复你的用户 ID

2. **设置 ADMIN_IDS 环境变量**

   **Koyeb 设置：**
   ```
   环境变量名: ADMIN_IDS
   环境变量值: 123456789,987654321
   ```

   **.env 文件设置（本地）：**
   ```env
   ADMIN_IDS=123456789,987654321
   ```

### 管理员命令

#### `/admin_stats`
查看全局统计数据
```
用法: /admin_stats
响应: 总用户数、活跃用户、禁用用户
```

#### `/blacklist [用户ID] [原因]`
拉黑用户（禁止使用机器人）
```
用法: /blacklist 123456789 垃圾广告
效果: 
  - 用户无法使用任何命令
  - 用户的提醒会停止
  - 数据保留（可解除拉黑后恢复）
```

#### `/unblacklist [用户ID]`
解除拉黑
```
用法: /unblacklist 123456789
效果: 用户恢复正常使用
```

#### `/user_info [用户ID]`
查看用户详细信息
```
用法: /user_info 123456789
信息包括:
  - 用户设置（目标、间隔、时区等）
  - 提醒和黑名单状态
  - 今日饮水量
  - 账户创建和最后交互时间
```

---

## 👤 普通用户新功能

### `/reset`
重置自己的所有饮水数据
```
用法: /reset
效果:
  - 删除所有饮水记录
  - 保留用户设置（目标、间隔等）
  - 提醒继续运行
```

### `/stop_today`
停止今天的提醒（不影响明天）
```
用法: /stop_today
效果: 今天不再接收提醒
说明: 明天会继续正常提醒
```

### `/disable_forever`
永久禁用提醒
```
用法: /disable_forever
效果:
  - 不再接收任何提醒
  - 可以继续记录饮水
  - 所有数据保留
```

### `/enable`
重新启用提醒
```
用法: /enable
效果: 按照设置重新发送提醒
```

---

## 🧹 自动清理过期用户

### 工作机制

```
用户 7 天未与机器人交互
         ↓
每日 00:00 UTC 检查一次
         ↓
发送最后提示消息给用户
         ↓
标记用户（给 24 小时反应时间）
         ↓
用户 24 小时内无反应
         ↓
删除所有数据（记录和配置）
         ↓
完全移除用户
```

### 时间轴

- **第 1-7 天：** 用户正常使用，任何交互都会更新时间戳
- **第 7 天末：** 00:00 UTC 检查，发现用户 7 天未交互
- **第 7 天 00:01：** 发送警告消息，给 24 小时反应时间
- **第 8 天 00:01：** 如果用户未反应，删除其全部数据

### 触发条件

- ❌ **不会被清理：** 
  - 最近 7 天有任何交互（发送命令、记录饮水等）
  - 黑名单用户（认为是故意不活跃）

- ✅ **会被清理：**
  - 7 天完全未交互
  - 收到警告后 24 小时仍未反应

---

## 📊 数据库变化

### 新增字段

#### Users 表
| 字段 | 类型 | 说明 |
|------|------|------|
| `last_interaction_time` | TIMESTAMP | 最后交互时间（用于清理检测） |
| `is_disabled` | INTEGER | 是否禁用提醒（1 = 禁用，0 = 启用） |

### 新增表

#### Blacklist 表
```sql
CREATE TABLE blacklist (
    user_id BIGINT PRIMARY KEY,
    reason VARCHAR(255),
    blocked_at TIMESTAMP
);
```

---

## 🚀 部署步骤

### Koyeb 部署

1. **修改 config.py 和 database.py**
   - ✅ 已完成

2. **修改 main.py 添加新命令**
   - ✅ 已完成

3. **提交代码到 GitHub**
   ```bash
   git add config.py database.py main.py .env.example
   git commit -m "Feature: Add admin system, user management, auto-cleanup"
   git push origin main
   ```

4. **Koyeb 自动部署**
   - 推送代码后，Koyeb 自动检测并部署

5. **配置环境变量**
   - 访问 Koyeb 仪表板
   - 进入应用 → Environment
   - 添加 `ADMIN_IDS` （可选）
   - 重启应用

### 本地运行

1. **更新 .env**
   ```env
   TELEGRAM_TOKEN=your_token
   DATABASE_URL=your_db_url
   PORT=8080
   ADMIN_IDS=123456789,987654321
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **运行**
   ```bash
   python main.py
   ```

---

## 🧪 功能测试

### 测试清单

#### 管理员功能
- [ ] 配置 ADMIN_IDS 环境变量
- [ ] 测试 `/admin_stats` 命令
- [ ] 测试 `/blacklist` 命令
- [ ] 测试 `/unblacklist` 命令
- [ ] 测试 `/user_info` 命令

#### 用户功能
- [ ] 测试 `/reset` 重置数据
- [ ] 测试 `/stop_today` 停止今日提醒
- [ ] 测试 `/disable_forever` 禁用提醒
- [ ] 测试 `/enable` 重新启用提醒

#### 自动清理
- [ ] 验证 `last_interaction_time` 更新
- [ ] 手动测试清理函数（可选）
- [ ] 验证警告消息发送
- [ ] 验证过期数据删除

#### 黑名单功能
- [ ] 拉黑后用户无法执行命令
- [ ] 拉黑用户的 Job 被删除
- [ ] 解除拉黑后恢复正常

---

## 📝 相关文档

| 文档 | 说明 |
|------|------|
| [README.md](README.md) | 项目说明 |
| [RENDER_AUTO_SLEEP_FIX.md](RENDER_AUTO_SLEEP_FIX.md) | 防止自动休眠 |
| [DEPLOYMENT_START_HERE.md](DEPLOYMENT_START_HERE.md) | 部署快速开始 |

---

## ⚠️ 注意事项

### ADMIN_IDS 配置

1. **不包含自己的 ID**
   ```
   # ❌ 错误：留空了
   ADMIN_IDS=
   
   # ✅ 正确
   ADMIN_IDS=123456789
   
   # ✅ 正确：多个管理员
   ADMIN_IDS=123456789,987654321
   ```

2. **获取你的 ID**
   - BotFather 不提供 ID
   - 使用 @userinfobot 查询
   - 或者创建一个简单机器人获取

### 清理策略说明

1. **为什么 7 天？**
   - 平衡点：既不过于激进，也不会保留太多僵尸账户
   - 可以根据需求在代码中调整

2. **为什么发送警告？**
   - 用户体验：给用户反应机会
   - 防止意外：网络问题可能导致无交互

3. **24 小时反应时间**
   - 足够用户发现和反应
   - 可以在代码中调整

---

## 🔐 安全建议

1. **管理员权限保护**
   - 不要泄露管理员 ID
   - 定期检查黑名单

2. **黑名单使用**
   - 有充分理由再使用
   - 被拉黑用户的数据会保留
   - 可以随时解除

3. **定期备份**
   - 备份数据库
   - 防止意外数据丢失

---

## 📞 故障排除

### 问题 1：管理员命令无权限

**症状：** 执行 `/admin_stats` 收到 "❌ 您没有权限执行此命令"

**解决：**
1. 确认你的 Telegram ID
2. 检查 ADMIN_IDS 环境变量是否正确
3. 确保 ID 之间用逗号分隔（无空格）
4. 重新部署应用

### 问题 2：清理任务未执行

**症状：** 过期用户未被删除

**解决：**
1. 查看应用日志，搜索 "清理过期用户"
2. 确认 APScheduler 已启动
3. 检查数据库连接是否正常

### 问题 3：黑名单用户仍可交互

**症状：** 拉黑后用户仍可发送消息

**解决：**
1. 查看日志确认拉黑操作成功
2. 检查是否在所有消息处理器中添加了黑名单检查
3. 重启应用

---

## 🎉 总结

**新增功能：**
- ✅ 管理员系统（4 个新命令）
- ✅ 用户数据管理（4 个新命令）
- ✅ 自动清理过期用户
- ✅ 黑名单功能
- ✅ 所有命令都支持交互时间追踪

**环境变量：**
- ✅ ADMIN_IDS - 设置管理员
- ✅ UPTIMEROBOT_URL - 可选保活

**数据库：**
- ✅ 新增 blacklist 表
- ✅ users 表新增 2 个字段

**部署：**
- ✅ 向后兼容（可无缝升级）
- ✅ 自动建表和迁移

---

**准备好了吗？** 推送代码到 GitHub，部署到 Koyeb！🚀
