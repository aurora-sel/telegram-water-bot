# 🔍 定时提醒故障排查指南

**快速诊断工具** - 帮助您快速解决提醒问题

---

## ✅ 验证清单

### 第 1 步：确认机器人已启动
```
操作：/start
预期：
✅ 收到欢迎消息
✅ 机器人说 "👋 欢迎来到喝水提醒机器人！"
```

**如果失败**：
```
原因可能：
- 机器人离线
- 用户已被拉黑
- 网络连接问题

解决：
1. 检查机器人是否正在运行
2. 查看日志中是否有错误信息
3. 尝试重启机器人
```

---

### 第 2 步：检查提醒间隔设置
```
操作：/interval 60
预期：
✅ 提醒间隔已设置为 60 分钟
```

**如果不确定当前间隔**：
```
操作：/stats
预期：
✅ 显示当前设置，包括提醒间隔
```

---

### 第 3 步：验证活跃时段设置
```
操作：/time 08:00 22:00
预期：
✅ 已设置活跃时段为 08:00 ~ 22:00
```

**检查当前时间**：
- 如果当前时间在 08:00 ~ 22:00 之间：提醒应该被发送
- 如果在这个范围外：提醒会被跳过

---

### 第 4 步：等待测试
```
1. 执行 /start 启动
2. 等待所设定的间隔时间（如 60 分钟）
3. 观察是否收到提醒消息

或者缩短间隔时间测试：
1. /interval 1（设置为 1 分钟）
2. 等待最多 1-2 分钟
3. 应该收到提醒消息
```

---

## 🔧 常见问题和解决方案

### 问题 1：启动后没有收到任何消息

**检查清单**：
- [ ] 机器人是否在运行？
- [ ] 是否执行了 `/start`？
- [ ] 是否被拉入黑名单？

**解决步骤**：
```
1. 检查机器人日志：
   grep "[调度]" logs.txt     # 查看调度日志
   
2. 查找用户 Job 创建日志：
   grep "为用户.*创建提醒" logs.txt
   
3. 如果看到"为用户 XXXXX 创建提醒 Job"，说明 Job 已创建
   
4. 等待间隔时间后查看：
   grep "已发送给用户" logs.txt
```

---

### 问题 2：收到的消息不是提醒，而是其他消息

**检查**：
- [ ] 是开始通知（08:00）吗？
- [ ] 是结束报告（22:00）吗？
- [ ] 是用户名单清理的警告吗？

**这些都不是定时提醒** ❌

**定时提醒的样子**：
```
💧 是时候喝水了！

📊 今日进度
已喝: XXXml / XXXXml (XX%)
还需: XXXml

📝 直接发送数字（如 200）记录饮水量
```

---

### 问题 3：消息发送时间不对

| 预期时间 | 实际时间 | 原因 | 解决方案 |
|---------|---------|------|---------|
| 每 60 分钟 | 没有按时发送 | 时区设置错误 | `/timezone 8` |
| 每 60 分钟 | 随机时间发送 | Job 异常 | 重启机器人 |
| 每 60 分钟 | 不在活跃时段 | 时间范围设置 | `/time 08:00 22:00` |

---

### 问题 4：收到的消息显示错误的数据

**检查**：
```
消息显示：已喝 500ml / 0ml (错误！)

原因：daily_goal 设置为 0

解决：
/goal 2000    # 设置每日目标为 2000ml
```

---

## 🛠 调试技巧

### 查看机器人日志

#### Linux/Mac 用户
```bash
# 查看最近的日志
tail -f logs.txt | grep "提醒\|调度"

# 搜索特定用户的日志
grep "用户 123456789" logs.txt
```

#### Windows 用户
```powershell
# 查看包含"调度"的日志行
Select-String "调度" logs.txt

# 实时查看日志（需要 Get-Content）
Get-Content logs.txt -Wait | Select-String "提醒"
```

---

### 重启提醒

如果提醒停止了，可以通过以下方式重启：

```
1. /stop_today      # 停止今天的提醒
   然后
   /start            # 重新启动

2. 或者修改间隔
   /interval 60      # 重新设置间隔（会创建新的 Job）
```

---

### 手动测试（开发者）

```python
# 在 Python 中手动触发提醒
import asyncio
from main import bot, db, send_reminder

async def test_reminder(user_id):
    # 手动调用发送函数
    user = await db.get_or_create_user(user_id)
    # 手动发送测试消息
    await bot.send_message(
        user_id,
        "🧪 测试提醒"
    )

asyncio.run(test_reminder(123456789))
```

---

## 📊 日志分析

### 正常的提醒日志

```
[调度] 为用户 123456789 创建提醒 Job (间隔 60 分钟)
...（等待 60 分钟）...
[提醒] 已发送给用户 123456789
```

### 异常的提醒日志

| 日志内容 | 原因 | 解决方案 |
|---------|------|---------|
| `用户 X 在黑名单中，跳过创建 Job` | 用户被拉黑 | 管理员执行 `/unblacklist X` |
| `用户 X 已禁用提醒，跳过创建 Job` | 用户禁用了提醒 | 用户执行 `/enable` |
| `不在活跃时段，跳过提醒` | 时间不在设定范围 | 修改 `/time` 或等待活跃时段 |
| `发送给用户 X 失败: ...` | 消息发送异常 | 检查网络，重启机器人 |

---

## ✨ 期望行为

### 首次启动
```
用户：/start
机器人：显示欢迎消息 + 当前设置
后台：创建 3 个 Job（定时提醒 + 开始通知 + 结束报告）
等待：按设定间隔发送消息
```

### 正常运行
```
08:00  → 🌅 每日开始通知
10:00  → 💧 定时提醒（假设间隔是 2 小时）
12:00  → 💧 定时提醒
14:00  → 💧 定时提醒
22:00  → 📋 每日结束报告
24:00  → 新的一天开始
```

### 用户记录饮水
```
用户：200ml
机器人：确认 + 显示进度
后台：重置提醒 Job（重新计时）
```

---

## 🎯 快速修复步骤

### 步骤 1：重新启动
```
/stop_today
/start
```

### 步骤 2：检查时区
```
/timezone 8    # 根据你的位置调整
```

### 步骤 3：设置间隔
```
/interval 60   # 设置为 60 分钟
```

### 步骤 4：设置活跃时段
```
/time 08:00 22:00   # 设置为这个时间范围
```

### 步骤 5：等待验证
```
等待最长 interval_min 分钟，观察是否收到消息
```

---

## 📞 获取帮助

如果上述步骤都不能解决问题：

1. 查看完整文档：[REMINDER_FIX_REPORT.md](REMINDER_FIX_REPORT.md)
2. 检查日志输出
3. 验证 APScheduler 是否正确启动
4. 查看数据库连接是否正常

---

## 🎓 相关文档

- [REMINDER_FIX_REPORT.md](REMINDER_FIX_REPORT.md) - 修复报告
- [DAILY_NOTIFICATIONS.md](DAILY_NOTIFICATIONS.md) - 每日通知说明
- [ADMIN_SETUP.md](ADMIN_SETUP.md) - 管理员功能

