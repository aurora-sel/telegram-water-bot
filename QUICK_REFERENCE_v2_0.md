# 🎯 快速参考卡 - 机器人 v2.0 新功能

**版本：** 2.0 | **日期：** 2026-02-03 | **状态：** ✅ 完成

---

## 🔐 管理员设置（一次性）

### 1. 获取你的 Telegram ID
```
找 @userinfobot，发送任意消息，它会告诉你你的 ID
```

### 2. 在 Koyeb 中配置
```
Environment → Add Variable
名称: ADMIN_IDS
值: 123456789,987654321  (用逗号分隔，无空格)
```

### 3. 重启应用
```
Deploy → 完成
```

---

## 👤 普通用户新命令

| 命令 | 效果 | 说明 |
|------|------|------|
| `/reset` | 清空记录 | 删除所有饮水记录，保留设置 |
| `/stop_today` | 停今日提醒 | 明天继续正常 |
| `/disable_forever` | 禁用提醒 | 永久停止，可手动记录 |
| `/enable` | 启用提醒 | 恢复提醒功能 |

---

## 👨‍💼 管理员新命令

| 命令 | 用途 |
|------|------|
| `/admin_stats` | 查看统计（总用户、活跃、禁用） |
| `/blacklist ID 原因` | 拉黑用户 |
| `/unblacklist ID` | 解除拉黑 |
| `/user_info ID` | 查看用户详情 |

---

## 🔄 自动清理机制

```
检测标准：7 天未交互
执行时间：每日 00:00 UTC
步骤：
  1️⃣ 发送警告信息给用户
  2️⃣ 给 24 小时反应时间
  3️⃣ 如果用户未反应，删除全部数据
```

---

## 🌐 环境变量（部署时填写）

| 变量 | 必需 | 说明 |
|------|------|------|
| `TELEGRAM_TOKEN` | ✅ | Bot Token |
| `DATABASE_URL` | ✅ | PostgreSQL URL |
| `PORT` | ❌ | 默认 8080 |
| `ADMIN_IDS` | ❌ | 管理员 ID（逗号分隔） |
| `UPTIMEROBOT_URL` | ❌ | 保活 URL（可选） |

---

## 📋 新增权限检查

✅ **黑名单检查** - 被拉黑用户无法：
- 发送任何命令
- 记录饮水
- 查看数据
- 修改设置

✅ **禁用检查** - 禁用用户无法：
- 接收自动提醒
- 但可手动记录饮水

---

## 🚀 3 步快速部署

```bash
# 1️⃣ 推送代码
git add .
git commit -m "Update to v2.0"
git push origin main

# 2️⃣ Koyeb 自动部署（或手动）
# 访问仪表板，应用应自动检测并部署

# 3️⃣ 配置管理员（可选）
# Koyeb → Environment → 添加 ADMIN_IDS → Deploy
```

---

## ✅ 部署验证清单

- [ ] 应用状态 = Healthy
- [ ] 日志中有 "机器人已启动" 信息
- [ ] 能给机器人发送 `/start` 并收到回复
- [ ] 如设置了管理员，测试 `/admin_stats` 有权限检查
- [ ] 测试新命令（`/reset` 等）能正常执行

---

## 📊 数据库改变

**新字段：**
- `last_interaction_time` - 最后交互时间（用于清理）
- `is_disabled` - 是否禁用提醒

**新表：**
- `blacklist` - 拉黑用户列表

**自动创建** - 无需手动操作

---

## 🎯 典型使用场景

### 场景 1：我想重置我的记录
```
用户：/reset
机器人：✅ 你的记录已清除，设置保留
```

### 场景 2：我想停止提醒（但保留数据）
```
用户：/disable_forever
机器人：✅ 提醒已禁用，可继续手动记录
```

### 场景 3：有坏用户发垃圾（管理员）
```
管理员：/blacklist 123456 垃圾
机器人：✅ 已拉黑
该用户：❌ 无法使用任何功能
```

### 场景 4：查看全局统计（管理员）
```
管理员：/admin_stats
机器人：显示总用户数、活跃用户、禁用用户
```

---

## 🔧 常见配置

### 单个管理员
```env
ADMIN_IDS=123456789
```

### 多个管理员
```env
ADMIN_IDS=123456789,987654321,111111111
```

### 不设置管理员
```env
ADMIN_IDS=
# 或者不填这个环境变量
```

---

## 📝 文档导航

| 文档 | 用途 |
|------|------|
| **README.md** | 项目全面说明 |
| **FEATURE_UPDATE_2_0.md** | 新功能详细文档 |
| **UPDATE_GUIDE_v2_0.md** | 部署和更新指南 |
| **COMPLETION_VERIFICATION.md** | 完成验证报告 |

---

## ⚠️ 重要提醒

🔴 **不要：**
- 在代码中硬编码 ADMIN_IDS
- 分享你的 Telegram ID
- 随意拉黑用户

🟢 **应该：**
- 只在 Koyeb 环境变量中设置
- 定期检查黑名单
- 备份数据库

---

## 🆘 快速故障排除

**问题：** 管理员命令说没权限  
**解决：** 确认 ADMIN_IDS 已设置，包含你的 ID，重启应用

**问题：** 清理任务没执行  
**解决：** 查看日志，确保 APScheduler 正常启动

**问题：** 被拉黑的用户仍可发消息  
**解决：** 检查应用是否重启，黑名单是否生效

---

## 📞 获取帮助

遇到问题？查看：
1. 📖 详细文档（见上面的导航）
2. 🔍 应用日志（Koyeb 仪表板）
3. 🐛 检查代码中的日志输出

---

**现在就部署吧！** 🚀

按照 3 步快速部署说明，你的机器人将获得强大的管理和用户管理功能！
