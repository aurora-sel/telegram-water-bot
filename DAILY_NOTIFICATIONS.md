# 📋 每日通知功能指南（v2.1）

## 功能概述

每日通知功能为用户提供两个自动化的每日消息：
1. **每日开始通知** 🌅 - 在开始时间发送
2. **每日结束报告** 📋 - 在结束时间发送

---

## 🌅 每日开始通知

### 何时发送
- **触发时间**：用户设置的 `开始时间`
- **例如**：用户设置活跃时段为 `08:00 ~ 22:00`，则在每天 08:00 发送

### 消息内容
```
🌅 新的一天开始了！

📊 今日目标: [用户设置的每日目标] ml

💪 [随机鼓励语]

直接发送数字（如 200）记录饮水量
```

### 示例
```
🌅 新的一天开始了！

📊 今日目标: 2000 ml

💪 新的一天，新的开始！让我们一起喝水吧！

直接发送数字（如 200）记录饮水量
```

### 作用
- ✅ 提醒用户新的一天已开始
- ✅ 显示今日的目标
- ✅ 使用鼓励语激励用户
- ✅ 快速导引用户开始记录

---

## 📋 每日结束报告

### 何时发送
- **触发时间**：用户设置的 `结束时间`
- **例如**：用户设置活跃时段为 `08:00 ~ 22:00`，则在每天 22:00 发送

### 消息内容
```
📋 今日喝水报告

🎯 目标: [目标值] ml
💧 实际: [今日实际值] ml
📊 完成度: [百分比]%
状态: [已达成/未达成]

[对比符号] 与昨日对比
[对比结果]
（昨日: [昨日值] ml）

🌙 [随机完成语]
```

### 示例 1（超额完成）
```
📋 今日喝水报告

🎯 目标: 2000 ml
💧 实际: 2500 ml
📊 完成度: 125%
状态: ✅ 已达成

🎉 与昨日对比
📈 比昨天多喝了 300ml，继续保持！
（昨日: 2200 ml）

🌙 太棒了！今天表现不错。良好的习惯会让你更健康！
```

### 示例 2（未达成但有进步）
```
📋 今日喝水报告

🎯 目标: 2000 ml
💧 实际: 1800 ml
📊 完成度: 90%
状态: ❌ 未达成

💪 与昨日对比
📈 比昨天多喝了 200ml，继续加油！
（昨日: 1600 ml）

🌙 今天虽然还差一点，但已经在进步了！明天继续加油！
```

### 示例 3（持平）
```
📋 今日喝水报告

🎯 目标: 2000 ml
💧 实际: 2000 ml
📊 完成度: 100%
状态: ✅ 已达成

👍 与昨日对比
➡️ 与昨天持平，保持稳定！
（昨日: 2000 ml）

🌙 保持今天的节奏，你正在养成良好习惯！
```

### 作用
- ✅ 总结今日的饮水情况
- ✅ 与目标对比，提供明确的完成度
- ✅ 与昨日数据对比，鼓励用户进步
- ✅ 激励用户持续改进

---

## ⚙️ 自动配置

### 何时创建通知任务
通知任务在以下时机自动创建：

1. **用户首次启动** `/start`
   - 自动为新用户创建两个通知任务

2. **用户启用提醒** `/enable`
   - 重新创建通知任务

3. **用户更改活跃时段** `/time`
   - 自动更新通知任务的触发时间

### 用户设置的影响

| 设置 | 影响 |
|------|------|
| 开始时间 | 决定每日开始通知的发送时间 |
| 结束时间 | 决定每日结束报告的发送时间 |
| 时区 | 用于计算用户本地的每日数据范围 |
| 禁用状态 | 禁用时停止所有通知 |
| 黑名单状态 | 拉黑用户时停止所有通知 |

---

## 🔧 开发者说明

### 核心函数

#### `create_daily_start_notification(user_id)`
为用户创建每日开始通知任务
- **参数**：用户 ID
- **任务 ID**：`daily_start_{user_id}`
- **触发器**：CronTrigger（小时和分钟）

#### `create_daily_end_report(user_id)`
为用户创建每日结束报告任务
- **参数**：用户 ID
- **任务 ID**：`daily_end_{user_id}`
- **触发器**：CronTrigger（小时和分钟）

#### `db.get_daily_total(user_id, days_ago, timezone)`
获取指定日期的饮水总量
- **参数**：
  - `user_id`：用户 ID
  - `days_ago`：0=今天，1=昨天，2=前天
  - `timezone`：用户时区
- **返回**：该日期的总饮水量（毫升）

### 数据精准性

✅ **时区处理**
- 所有日期计算都考虑用户时区
- 存储在数据库中的所有时间都是 UTC 格式
- 查询时动态转换为用户本地时间

✅ **每日范围**
- 今天 00:00（本地时间）~ 明天 00:00（本地时间）
- 昨天范围自动计算

✅ **饮水数据**
- 包含用户当日所有记录
- 支持补录功能（`/back` 命令）

---

## 📱 用户视角

### 典型的每日流程

```
08:00 → 🌅 每日开始通知 (提醒用户开始喝水)
     ↓
用户记录多次饮水 (如: 200ml, 300ml, 200ml...)
     ↓
22:00 → 📋 每日结束报告 (总结今日成果)
     ↓
00:00 → 新的一天开始...
```

### 命令关系

```
/start          → 创建开始通知和结束报告
  ↓
/time           → 更新通知时间
  ↓
/disable_forever → 禁用所有通知
  ↓
/enable         → 恢复所有通知
```

---

## 🐛 故障排查

### 问题：没有收到通知

**可能原因**：
1. ❌ 未执行 `/start` 命令
2. ❌ 已执行 `/disable_forever`
3. ❌ 已被拉入黑名单
4. ❌ 时间设置不正确
5. ❌ 时区设置错误

**解决方案**：
```
/start              # 重新启动
/time 08:00 22:00   # 验证时间设置
/timezone 8         # 验证时区设置
/enable             # 如果已禁用则启用
```

### 问题：结束报告中的对比数据不准确

**可能原因**：
- 时区设置错误导致日期范围计算有误

**解决方案**：
```
/timezone [正确的时区数字]  # 如北京时间应为 8
```

---

## 📊 参考数据

### 鼓励语
系统从 `config.py` 的 `ENCOURAGEMENT_MESSAGES` 列表随机选择

### 完成语
系统从 `config.py` 的 `COMPLETION_MESSAGES` 列表随机选择

可在 [config.py](config.py) 中自定义这些消息内容。

---

## 🔄 版本历史

| 版本 | 日期 | 功能 |
|------|------|------|
| v2.0 | 2026-01-xx | 用户管理和管理员功能 |
| v2.1 | 2026-02-04 | 每日通知功能 |

